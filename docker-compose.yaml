version: '3.8'

services:
  puppet-master:
    image: puppet/puppetserver:latest
    container_name: puppet-master
    ports:
      - "8140:8140"  # Expose port 8140 for Puppet communication
    networks:
      - puppet_network
    environment:
      - SERVER_NAME=puppet-master
    volumes:
      - puppet-server-config:/etc/puppetlabs/puppetserver  # Persistent config storage
      - puppet-logs:/var/log/puppetlabs/puppetserver  # Persistent log storage
    command: ["puppetserver", "foreground"]

  puppet-agent:
    image: puppet/puppet-agent:latest
    container_name: puppet-agent
    depends_on:
      - puppet-master  # Ensure the puppet-master is up before starting the agent
    networks:
      - puppet_network
    environment:
      - PUPPET_SERVER=puppet-master  # Use the service name as hostname
    entrypoint: ["puppet", "agent", "-t"]  # Run the agent automatically on start
    volumes:
      - puppet-agent-config:/etc/puppetlabs/puppet  # Persistent agent configuration

networks:
  puppet_network:
    driver: bridge  # Use the bridge network for communication between containers

volumes:
  puppet-server-config:
  puppet-logs:
  puppet-agent-config:
